<?php
namespace Admin\Controller;
use Think\Controller;
class AdminController extends Controller{
	public function lis(){
		$data=D('admin')->alias('a')->join('left join bbs_role as r  on a.admin_role=r.id')->field('a.*,r.role_name')->select();
		$count=D('admin')->count();
		$this->assign('count',$count);
		$this->assign('data',$data);
		// dump($data);
		$this->display('admin-list');

	}

	public function add(){
		// echo 1;die();
		if(IS_POST){
			$data=I('post.');
			//判空
			if (empty($data["adminname"])||empty($data["adminpass"])||empty($data["adminphone"])||empty($data["adminemail"])||empty($data["adminroleid"])) {
				$return=array(
				'code'=>10001,
				'msg'=>'数据为空'
				);
				$this->ajaxReturn($return);
			}
			//判断用户名是否重复
			$repeat=D('admin')->where(['admin_name'=>$data['adminname']])->find();
			if ($repeat!=null) {
				$return=array(
				'code'=>10001,
				'msg'=>'账号重复'
				);
				$this->ajaxReturn($return);
			}
			$data['adminpass']=encrypt_password($data['adminpass']);
			$data['create_time']=date('Y-m-d H:i:s');
			$data['login_ip']=ip2long($_SERVER['REMOTE_ADDR']);
			$admin=D('admin');
			$admin->create($data);
			$res=$admin->add();
			if ($res) {
				$return=array(
				'code'=>10000,
				'msg'=>'插入成功'
				);
				$this->ajaxReturn($return);
			}else{
				$return=array(
				'code'=>10001,
				'msg'=>'插入失败'
				);
				$this->ajaxReturn($return);
			}
					
		}else{
			$data=M('role')->select();
			$this->assign('data',$data);
			$this->display('admin-add');
		}
		
	}
	public function edit(){
		if (IS_POST) {
			$data=I('post.');
			if (empty($data["adminname"])||empty($data["adminpass"])||empty($data["adminphone"])||empty($data["adminemail"])||empty($data["adminroleid"])) {
				$return=array(
				'code'=>10001,
				'msg'=>'数据为空'
				);
				$this->ajaxReturn($return);
			}
			$data['adminpass']=encrypt_password($data['adminpass']);
			$admin=D('admin');
			$admin->create($data);
			$res=$admin->save();
			if ($res) {
				$return=array(
				'code'=>10000,
				'msg'=>'插入成功'
				);
				$this->ajaxReturn($return);
			}else{
				$return=array(
				'code'=>10001,
				'msg'=>'插入失败'
				);
				$this->ajaxReturn($return);
			}
		}else{
			$id=I('get.id');
			$data=D('admin')->find(['id'=>$id]);
			$role=M('role')->select();
			$this->assign('role',$role);
			$this->assign('data',$data);
			$this->display('admin-edit');	
		}
			
	}
	public function role(){
		$data=D('role')->select();
		$this->assign('data',$data);
		$this->display('admin-role');
	}
	public function cate(){
		$this->display('admin-cate');
	}
	public function rule(){
		$data=D('auth')->select();
		$count=D('auth')->count();
		$data=getTree($data);
		// dump($data);die;
		$this->assign('count',$count);
		$this->assign('data',$data);
		$this->display('admin-rule');
	}
	public function role_edit(){
		$this->display('role-edit');
	}
	public function role_add(){
		if (IS_POST) {
			

		}else{
			$data=D('auth')->where(['pid'=>0])->select();
			$data1=D('auth')->where('pid > 0')->select();
			
			$this->assign('data',$data);
			$this->assign('data1',$data1);
			$this->display('role-add');
		}
		
	}
	//更改管理员状态
	public function admin_state(){
		$id=I('post.id');
		if (empty($id)) {
			$retuen =[
				'code'=>'10001',
				'msg'=>'id为空'
			];
			$this->ajaxReturn($retuen);
		}	
			
		$res=D('admin')->where(['id'=>$id])->find();
		
		if ($res==null) {
			$retuen =[
				'code'=>'10001',
				'msg'=>'管理员不存在'
			];
			$this->ajaxReturn($retuen);
		}
		if ($res['admin_state']==0) {
			$data=D('admin')->where(['id'=>$id])->setField('admin_state','1');
			$state='1';
		}else{
			$data=D('admin')->where(['id'=>$id])->setField('admin_state','0');
			$state='0';
		}
		if ($data!=0) {
			$retuen =[
				'code'=>'10000',
				'state'=>$state,
				'msg'=>'修改成功'
			];
			$this->ajaxReturn($retuen);
		}else{
			$retuen =[
				'code'=>'10001',
				'msg'=>'修改失败'
			];
			$this->ajaxReturn($retuen);
		}
		
	}

	public function admin_del(){
		$id=I('post.id');
		if (empty($id)) {
			$retuen=[
			'code'=>'10001',
			'msg'=>'id为空'

			];
			$this->ajaxReturn($retuen);
		}
		$res=D('admin')->where(['id'=>$id])->find();
		if ($res==null) {
			$retuen=[
			'code'=>'10001',
			'msg'=>'不存在用户'

			];
			$this->ajaxReturn($retuen);
		}
		$data=D('admin')->where(['id'=>$id])->delete();
		if ($data!=false) {
			$retuen=[
			'code'=>'10000',
			'msg'=>'删除成功'

			];
			$this->ajaxReturn($retuen);
		}else{
			$retuen=[
			'code'=>'10001',
			'msg'=>'删除失败'

			];
			$this->ajaxReturn($retuen);
		}

	}
	public function delAll(){
		$id=I('post.id');
		if (empty($id)) {
			$retuen=[
			'code'=>'10001',
			'msg'=>'id为空'

			];
			$this->ajaxReturn($retuen);
		}
		$res=D('admin')->delete($id);
		if ($res!=false && $res!=0) {
			$retuen=[
			'code'=>'10000',
			'msg'=>'删除成功'

			];
			$this->ajaxReturn($retuen);
		}else{
			$retuen=[
			'code'=>'10001',
			'msg'=>'删除失败'

			];
			$this->ajaxReturn($retuen);
		}
	}
	public function rule_edit(){
		$this->display('link-edit');
	}

}